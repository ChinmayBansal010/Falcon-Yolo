<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOv8 Intelligence Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #bb86fc;
            --secondary-color: #03dac6;
            --font-color: #e0e0e0;
            --error-color: #cf6679;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
        }
        body {
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 6px 1px var(--secondary-color); }
            50% { box-shadow: 0 0 12px 4px var(--secondary-color); }
        }
        @keyframes textUpdate {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .header {
            padding: 12px 30px;
            background-color: var(--surface-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            z-index: 100;
        }
        .header h1 { font-size: 1.6em; }
        .live-indicator { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--secondary-color); font-weight: 500; }
        .live-indicator::before { content: ''; width: 10px; height: 10px; background-color: var(--secondary-color); border-radius: 50%; animation: pulseGlow 2s infinite; }
        .main-content { display: flex; gap: 20px; padding: 20px; flex-grow: 1; overflow: hidden; }
        .video-container {
            flex-grow: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            background-color: #000;
            position: relative;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
            animation: fadeIn 0.6s ease-out forwards;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }
        .video-container.has-detection { border-color: var(--primary-color); }
        .video-container img { width: 100%; height: 100%; object-fit: contain; }
        .video-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .sidebar {
            width: 450px;
            flex-shrink: 0;
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.8s ease-out 0.2s forwards;
            opacity: 0;
            border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }
        .sidebar-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }
        .sidebar-item h3 {
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        .sidebar-item i { color: var(--primary-color); }
        .detections-section {
            /* This section no longer needs to grow, the parent handles scrolling. */
        }
        .detection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #2c2c2e;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .detection-item.detected {
            background-color: var(--primary-color);
            border-left-color: var(--secondary-color);
            color: #121212;
            font-weight: 500;
        }
        .detection-item .count {
            font-weight: bold;
            font-size: 1.1em;
            background-color: rgba(0,0,0,0.3);
            color: var(--font-color);
            padding: 4px 10px;
            border-radius: 5px;
            min-width: 40px;
            text-align: center;
        }
        .detection-item .count.updated { animation: textUpdate 0.4s ease-in-out; }
        .chart-container {
            min-height: 250px; /* Use min-height to ensure space for the chart */
            flex-shrink: 0;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        #confidenceValue { color: var(--primary-color); font-weight: bold; }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
            outline: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--font-color);
            border-radius: 50%;
            border: 3px solid var(--surface-color);
            box-shadow: 0 0 8px rgba(0,0,0,0.7);
            transition: transform 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); }
    </style>
</head>
<body>
    <header class="header">
        <h1><i class="fas fa-robot"></i> Intelligence Dashboard</h1>
        <div class="live-indicator">LIVE</div>
    </header>
    <main class="main-content">
        <div class="video-container" id="videoContainer">
            <div class="video-overlay" id="videoOverlay"><div class="spinner"></div></div>
            <img src="" alt="Video Stream" id="videoStream" style="display: none;">
        </div>
        <aside class="sidebar">
            <div class="sidebar-item">
                <h3><i class="fas fa-microchip"></i> Model Status</h3>
                <p><strong>Status:</strong> <span id="status">Connecting...</span></p>
                <p><strong>Version:</strong> <span id="modelVersion">N/A</span></p>
            </div>
            <div class="sidebar-item detections-section">
                <h3><i class="fas fa-search"></i> Active Tracks</h3>
                <div id="detectionCounts"><p>Waiting for model data...</p></div>
            </div>
            <div class="chart-container">
                <canvas id="detectionChart"></canvas>
            </div>
            <div class="sidebar-item">
                <h3><i class="fas fa-sliders"></i> Controls</h3>
                <label for="confidence">Confidence: <span id="confidenceValue">0.40</span></label>
                <input type="range" id="confidence" name="confidence" min="0.1" max="0.9" step="0.05" value="0.40">
            </div>
        </aside>
    </main>
    <script>
        const videoContainer = document.getElementById('videoContainer');
        const videoOverlay = document.getElementById('videoOverlay');
        const videoStream = document.getElementById('videoStream');
        const statusSpan = document.getElementById('status');
        const modelVersionSpan = document.getElementById('modelVersion');
        const detectionCountsDiv = document.getElementById('detectionCounts');
        let classNames = [];
        let isInitialized = false;

        function initializeDetectionList(names) {
            classNames = names.sort();
            let html = '';
            classNames.forEach(name => {
                html += `<div class="detection-item" id="det-${name}"><span class="name">${name}</span><span class="count">0</span></div>`;
            });
            detectionCountsDiv.innerHTML = html;
            isInitialized = true;
        }

        videoStream.onload = () => {
            videoOverlay.style.display = 'none';
            videoStream.style.display = 'block';
        };
        videoStream.onerror = () => { videoOverlay.innerHTML = '<span>Stream Error</span>'; };
        videoStream.src = "{{ url_for('video_feed_laptop') }}";
        
        const eventSource = new EventSource("/events");
        
        eventSource.onopen = () => { statusSpan.textContent = 'Connected'; statusSpan.style.color = 'var(--secondary-color)'; };
        eventSource.onerror = () => { statusSpan.textContent = 'Disconnected'; statusSpan.style.color = 'var(--error-color)'; eventSource.close(); };

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.model_version && modelVersionSpan.textContent !== data.model_version) {
                modelVersionSpan.textContent = data.model_version;
            }
            
            if (data.class_names && !isInitialized) {
                initializeDetectionList(data.class_names);
            }

            if (data.tracks && isInitialized) {
                let hasDetections = false;
                const currentCounts = data.tracks || {};
                classNames.forEach(name => {
                    const count = currentCounts[name] || 0;
                    const item = document.getElementById(`det-${name}`);
                    if (!item) return;
                    const countSpan = item.querySelector('.count');
                    
                    if (parseInt(countSpan.textContent) !== count) {
                        countSpan.textContent = count;
                        countSpan.classList.add('updated');
                        setTimeout(() => countSpan.classList.remove('updated'), 400);
                    }
                    
                    if (count > 0) {
                        item.classList.add('detected');
                        hasDetections = true;
                    } else {
                        item.classList.remove('detected');
                    }
                });

                if (hasDetections) {
                    videoContainer.classList.add('has-detection');
                    setTimeout(() => videoContainer.classList.remove('has-detection'), 500);
                }
            }
        };

        const confidenceSlider = document.getElementById('confidence');
        const confidenceValueSpan = document.getElementById('confidenceValue');
        confidenceSlider.addEventListener('input', function() {
            const confidence = this.value;
            confidenceValueSpan.textContent = parseFloat(confidence).toFixed(2);
            fetch('/set_confidence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confidence: confidence }),
            });
        });

        const ctx = document.getElementById('detectionChart').getContext('2d');
        const chartGradient = ctx.createLinearGradient(0, 0, 0, 250);
        chartGradient.addColorStop(0, 'rgba(3, 218, 198, 0.7)');
        chartGradient.addColorStop(1, 'rgba(187, 134, 252, 0.7)');

        const detectionChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: [], datasets: [{
                label: 'Detections / Min',
                data: [],
                backgroundColor: chartGradient,
                borderColor: 'rgba(187, 134, 252, 1)',
                borderWidth: 1,
                borderRadius: 5,
                borderSkipped: false
            }] },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                animation: { duration: 800, easing: 'easeOutCubic' },
                scales: { 
                    y: { grid: { display: false }, ticks: { color: 'white', font: { size: 14 } } }, 
                    x: { grid: { color: 'rgba(255,255,255,0.1)', borderDash: [2, 4] }, ticks: { color: 'white', stepSize: 1 } } 
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Detection Frequency (Last 60s)', color: 'white', font: { size: 16 } },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 5,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.x !== null) { label += context.parsed.x; }
                                return '  ' + label;
                            }
                        }
                    }
                }
            }
        });

        function updateChart() {
            fetch('/chart_data')
                .then(response => response.json())
                .then(data => {
                    detectionChart.data.labels = data.labels;
                    detectionChart.data.datasets[0].data = data.values;
                    detectionChart.update();
                });
        }
        setInterval(updateChart, 2000);
    </script>
</body>
</html>